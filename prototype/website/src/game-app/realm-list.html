<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="mega-loader.html">

<!--
    @author Robin Duda
    Polymer element for a simple admin-panel using iron-pages.
 -->

<dom-module id="realm-list">
    <link rel="import" href="../style/theme.css" type="css">
    <link rel="import" href="../style/style.css" type="css">
    <template>
        <style>
            :host {
                display: block;
            }

            paper-button {
                text-align: left;
            }

            .container {
                width: 80%;
                max-width: 825px;
                margin-top: 128px;
                display: block;
            }

            .titles {
                width: 100%;
                margin-top: 12px;
            }

            .name-title {
                margin-left: 8px;
                width: 36%;
                float: left;
                margin-top: 6px;
            }

            .name {
                margin-left: 20px;
                width: 34%;
                float: left;
                margin-top: 6px;
            }

            .type {
                width: 12%;
                float: left;
                margin-top: 6px;
            }

            .reset {
                width: 14%;
                float: left;
                margin-top: 6px;
                padding-left: 0px;
            }

            .players {
                width: 18%;
                float: left;
                margin-top: 6px;
            }

            .ping {
                width: 7%;
                float: left;
                margin-top: 6px;
                padding-left: 0px;
            }

            .info {
                margin-top: 6px;
            }

            .description {
                font-size: 0.85em;
            }

            .item {
                text-align: center;
                position: relative;
                display: inline-block;
                width: 100%;
            }

            .status {
                position: relative;
                height: 32px;
                width: 100%;
            }

            .description {
                width: 65%;
            }

            .red {
                color: rgba(255, 87, 34, 1)
            }

            .orange {
                color: rgba(239, 108, 0, 1)
            }

            .yellow {
                color: rgba(255, 214, 0, 1);
            }

            .green {
                color: rgba(85, 139, 47, 1);
            }

            .mod-warning {
                text-align: center;
                width: 100%;
                position: absolute;
                font-size: smaller;
                margin-top: 14px;
            }

            #tabs {
                background-color: #000;
            }

            .realm-favorite {
                color: #ff0000;
                float: left;
                padding-right: 8px;
                margin-top: -4px;
            }

            .realm-favorite:hover {
                color: #ff0000;
                cursor: default;
            }

            .list {
                padding-bottom: 12px;
            }

            .loader {
                margin-top: 96px;
            }

            @media (max-width: 632px) {
                .container {
                    width: 100%;
                    margin-top: 46px;
                }

                .realm-favorite {
                    width: 16px;
                    margin-top: -2px;
                }

                .name-title {
                    width: 46%;
                }

                .players {
                    width: 24%;
                    text-align: left;
                    padding-left: 0px;
                }

                .name {
                    width: 46%;
                    text-align: left;
                }

                .type {
                    display: none;
                }

                .reset{
                    display: none;
                }

                .info {
                    display: none;
                }
            }
        </style>

        <paper-material class="container center-box" elevation="3">


            <paper-tabs id="tabs" selected="{{page}}" no-slide link>
                <paper-tab on-tap="trusted">Public</paper-tab>
                <paper-tab on-tap="untrusted">Private</paper-tab>
            </paper-tabs>

            <div hidden="{{trustedservers}}" class="mod-warning">
                <h5><span class="red"> Warning:</span> These servers may contain resources and code not
                    provided by &trade;.</h5>
            </div>

            <div class="titles">
                <paper-button class="name-title" on-tap="order" data-args="name">Name</paper-button>
                <paper-button class="type" on-tap="order" data-args="type">Type</paper-button>
                <paper-button class="reset" on-tap="order" data-args="lifetime">Reset</paper-button>
                <paper-button class="players" on-tap="order" data-args="players">Players</paper-button>
                <paper-button class="ping" on-tap="order" data-args="ping">Ping</paper-button>
            </div>

            <mega-loader class="loader" text="Loading realms.." enabled="[[loading]]"></mega-loader>

            <div class="list">
                <template is="dom-repeat" items="{{realms}}" as="realm" sort="{{sort}}">
                    <paper-material class="item noselect status" on-tap="select" hidden="{{realm.hidden}}"
                                    elevation="0">
                        <paper-ripple></paper-ripple>
                        <div class="name">

                            <template is="dom-if" if="{{favourite(realm.node)}}">
                                <iron-icon icon="icons:favorite-border" class="realm-favorite">
                                </iron-icon>
                            </template>

                            <template is="dom-if" if="{{realm.secure}}">
                                <iron-icon icon="icons:lock-outline" class="realm-favorite">
                                </iron-icon>
                            </template>

                            {{realm.node}}
                        </div>
                        <div class="type">[[realm.attributes.type]]</div>
                        <div class="reset">[[realm.attributes.lifetime]]</div>
                        <div class$="players {{realm.populationColor}}">
                            [[realm.players]]
                            <!-- show this in tooltip? [[realm.size]]-->
                        </div>

                        <div class$="ping {{realm.pingColor}}">{{realm.ping}}</div>

                        <iron-icon class="info" icon="icons:info-outline"></iron-icon>
                        <paper-tooltip animation-delay="0" class="tooltip">
                            <span class="description">[[realm.description]]</span>
                        </paper-tooltip>
                    </paper-material>
                </template>
            </div>

        </paper-material>

    </template>
</dom-module>

<script>
    class RealmList extends Polymer.Element {

        static get is() {
            return 'realm-list';
        }

        ready() {
            super.ready();
            this.page = 0;
            this.realms = [];
            this.trustedservers = true;
            this.set("sort", this.favoriteSort.bind(this));

            application.subscribe('view', (view) => {
                if (view === RealmList.is) {
                    if (this.realms.length === 0) {
                        this.loading = true;
                    }

                    this.update();
                    this.timer = setInterval(this.update.bind(this), 3000);
                }
            });

            application.onLogout(() => {
                clearInterval(this.timer);
            });
        }

        order(data) {
            switch (data.target.dataset.args) {
                case "name":
                    this.set("sort", this.nameSort);
                    break;
                case "type":
                    this.set("sort", this.typeSort);
                    break;
                case "lifetime":
                    this.set("sort", this.lifetimeSort);
                    break;
                case "players":
                    this.set("sort", this.playerSort);
                    break;
                case "ping":
                    this.set("sort", this.pingSort);
                    break;
            }
        }

        favourite(realm) {
            return true;//this.favourites[realm];
        }

        favoriteSort(a, b) {
            if (this.favourite(a.name) && !this.favourite(b.name))
                return -1;

            if (!this.favourite(a.name) && this.favourite(b.name))
                return 1;

            return this.nameSort(a, b);
        }

        nameSort(a, b) {
            if (a.name === b.name)
                return 0;
            return a.name < b.name ? -1 : 1;
        }

        typeSort(a, b) {
            if (a.type === b.type)
                return 0;
            return a.type < b.type ? -1 : 1;
        }

        lifetimeSort(a, b) {
            if (a.lifetime === b.lifetime)
                return 0;
            return a.lifetime < b.lifetime ? -1 : 1;
        }

        playerSort(a, b) {
            if (a.players === b.players)
                return 0;
            return a.players < b.players ? -1 : 1;
        }

        pingSort(a, b) {
            if (a.ping === b.ping)
                return 0;
            return a.ping < b.ping ? -1 : 1;
        }

        update() {
            new RealmRegistry().list({
                accepted: (data) => {
                    this.load(data.realms);
                    this.loading = false;
                },
                failed: (error) => {
                    clearInterval(this.timer);
                    application.error("Failed to retrieve realm list from realm registry.");
                    this.loading = false;
                }
            });
        }

        load(realmlist) {
            if (!this.realms)
                this.realms = [];

            this.refresh(realmlist);
            this.purge(realmlist);
            this.pingAll();

            this.set("realms", this.realms);
        }

        refresh(realmlist) {

            for (let i = 0; i < realmlist.length; i++) {
                let exists = false;

                for (let j = 0; j < this.realms.length; j++) {

                    if (realmlist[i].name === this.realms[j].name) {
                        realmlist[i].ping = this.realms[j].ping;
                        realmlist[i].state = this.realms[j].state;
                        this.set("realms." + j, realmlist[i]);
                        this.apply(j);
                        exists = true;
                    }
                }

                if (!exists)
                    this.push("realms", realmlist[i]);
            }
        }

        purge(realmlist) {
            for (let i = 0; i < this.realms.length - 1; i++) {
                let removed = true;

                for (let j = 0; j < realmlist.length; j++) {
                    if (this.realms[i].name === realmlist[j].name)
                        removed = false;
                }

                if (removed) {
                    this.splice("realms", i, 1);
                    i -= 1;
                }
            }
        }

        trusted() {
            this.trustedservers = true;
            this.applyAll();
        }

        untrusted() {
            this.trustedservers = false;
            this.applyAll();
        }

        applyAll() {
            if (this.realms && this.realms.hasOwnProperty('length')) {
                for (let i = 0; i < this.realms.length; i++) {
                    this.apply(i);
                }
            }
        }

        apply(i) {
            if (!this.realms[i].ping)
                this.realms[i].ping = '-';

            this.set("realms." + i + ".hidden", this.hidden(this.realms[i]));
            this.set("realms." + i + ".populationColor", this.populationColor(this.realms[i]));
            this.set("realms." + i + ".pingColor", this.pingColor(this.realms[i]));
            const tmp = this.sort;
            this.set("sort", null);
            this.set("sort", tmp);
        }

        pingColor(realm) {
            if (realm.ping < 50)
                return "green";
            if (realm.ping < 100)
                return "yellow";
            if (realm.ping < 150)
                return "orange";
            if (realm.ping >= 150 || realm.ping === "?")
                return "red";
            return "";
        }

        populationColor(realm) {
            const index = realm.players / realm.size;

            if (index > 0.9)
                return "red";
            if (index > 0.8)
                return "orange";
            if (index > 0.3)
                return "yellow";

            return "green";
        }

        hidden(realm) {
            return !(realm.trusted === this.trustedservers);
        }

        pingAll() {
            for (let i = 0; this.realms && i < this.realms.length; i++) {

                setTimeout(() => {
                    this.ping(this.realms[i]);
                }, i * 200);
            }
        }

        ping(realm) {
            const start = performance.now();

            RealmServer.ping({
                accepted: () => {
                    const ping = parseInt((performance.now() - start), 10);
                    this.setPing(realm, ping)
                },
                failed: () => {
                    this.setPing(realm, "?");
                }
            }, realm);
        }

        setPing(realm, ping) {
            for (let i = 0; i < this.realms.length; i++) {
                if (this.realms[i].node === realm.node) {
                    this.set("realms." + i + ".ping", ping);
                    this.apply(i);
                }
            }
        }

        select(event) {
            clearInterval(this.timer);
            application.selectRealm(event.model.realm);
        }
    }

    window.customElements.define(RealmList.is, RealmList);


</script>
