<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="./mega-loader.html">
<link rel="import" href="./ui/chat-box.html">
<link rel="import" href="./ui/player-status.html">
<link rel="import" href="./ui/spell-bar.html">
<link rel="import" href="./ui/game-menu.html">

<!--
    @author Robin Duda
    Polymer element as the game view.
 -->

<dom-module id="game-view">
    <link rel="import" href="../style/theme.css" type="css">
    <link rel="import" href="../style/style.css" type="css">
    <template>
        <style>
            :host {
                display: block;
                width: 100%;
                height: 100%;
                margin-bottom: -3px;
                padding: 0;
            }

            #canvas {
                animation: fadein 0.6s ease 1;
                position: absolute;
                width: 100%;
                height: 100%;
            }

            @keyframes fadein {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            #interface {
                animation: fadein 0.72s ease 1;
                position: absolute;
                z-index: 100;
                width: 100%;
                height: 100%;
            }
        </style>
        <div id="interface">

            <template is="dom-if" if="[[!loading]]">
                <player-status></player-status>
                <chat-box></chat-box>
                <spell-bar></spell-bar>
                <game-menu></game-menu>
            </template>
        </div>

        <canvas id="canvas"></canvas>

    </template>
    <script>
        class GameView extends Polymer.Element {

            static get is() {
                return 'game-view';
            }

            ready() {
                super.ready();

                application.onCompleteUpdate((event) => {
                    this.loading = true;
                    event.status('Initializing..');

                    window.server = event.server;
                    window.character = event.character;
                    window.patch = event.patch;
                    window.onScriptsLoaded = () => {
                    };
                    document.canvas = this.$.canvas;

                    try {
                        let index = 0;

                        // serializes loading of scripts.
                        let loader = (index) => {
                            if (index < event.patch.executable.length) {
                                let script = event.patch.executable[index];
                                event.status('init ' + script.split('.')[0]);

                                let reader = new FileReader();
                                reader.onload = () => {
                                    try {
                                        (1, eval)(reader.result);
                                        index++;
                                        loader(index);
                                    } catch (err) {
                                        this._handleError(err);
                                    }
                                };
                                if (event.patch.files[script]) {
                                    reader.readAsText(event.patch.files[script].data);
                                } else {
                                    application.error('Bootstrap script not downloaded: "' + script + '".');
                                }
                            } else {
                                event.status('Starting game..');

                                application.scriptsLoaded();
                                window.game.onScriptsLoaded({
                                    accepted: () => {
                                        // use the patching UI for loading the game scripts.
                                        application.showGame();
                                        this.loading = false;
                                    },
                                    error: (msg) => {
                                        this._handleError(new Error(msg));
                                    }
                                });
                            }
                        };
                        loader(index);
                    } catch (err) {
                        this._handleError(err);
                    }
                });
            }

            _handleError(err) {
                console.log(err.message);
                application.error(err.message);
                throw err;
            }
        }

        window.customElements.define(GameView.is, GameView);
    </script>
</dom-module>