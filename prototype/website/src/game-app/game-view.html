<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="./chat-box.html">

<!--
    @author Robin Duda
    Polymer element as the game view.
 -->

<dom-module id="game-view">
    <link rel="import" href="../style/theme.css" type="css">
    <link rel="import" href="../style/style.css" type="css">
    <template>
        <style>
            :host {
                display: block;
                width: 100%;
                height: 100%;
                margin-bottom: -3px;
                padding: 0;
            }

            #game {
                position: absolute;
                width: 100%;
                height: 100%;
            }

            #interface {
                position: absolute;
                z-index: 100;
                width: 100%;
                height: 100%;
            }
        </style>
        <div id="interface">
            <paper-button class="primary" on-tap="characters" raised>CHARACTERS</paper-button>


            <chat-box>
            </chat-box>

        </div>

        <canvas id="game">
        </canvas>

    </template>
    <script>
        class GameView extends Polymer.Element {

            static get is() {
                return 'game-view';
            }

            constructor() {
                super();

                // todo: should call join on the server before loading game.js

                application.onCompleteUpdate((event) => {
                    // store in global so that game.js can access them.
                    window.resources = event.resources;
                    window.server = event.server;
                    window.character = event.character;
                    window.patch = event.patch;
                    try {
                        let index = 0;

                        // serializes loading of scripts.
                        let loader = (index) => {
                            if (index < event.patch.executable.length) {
                                let script = event.patch.executable[index];
                                console.log("loading: " + script);

                                let reader = new FileReader();
                                reader.onload = function() {
                                    (1, eval)(reader.result);
                                    console.log("loaded: " + script);

                                    index++;
                                    loader(index);
                                }
                                reader.readAsText(event.patch.files[script].data);
                            }
                       }
                       loader(index);
                    } catch (err) {
                        console.log(err.message);
                        application.error(err.message);
                        throw err;
                    }
                    window.canvas = this.$.game;
                    window.context = event;
                });
            }

            characters(e) {
                shutdown();
                application.showCharacters();
            }
        }
        window.customElements.define(GameView.is, GameView);
    </script>
</dom-module>