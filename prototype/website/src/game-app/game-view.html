<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="./chat-box.html">
<link rel="import" href="./mega-loader.html">

<!--
    @author Robin Duda
    Polymer element as the game view.
 -->

<dom-module id="game-view">
    <link rel="import" href="../style/theme.css" type="css">
    <link rel="import" href="../style/style.css" type="css">
    <template>
        <style>
            :host {
                display: block;
                width: 100%;
                height: 100%;
                margin-bottom: -3px;
                padding: 0;
            }

            #canvas {
                position: absolute;
                width: 100%;
                height: 100%;
            }

            #interface {
                position: absolute;
                z-index: 100;
                width: 100%;
                height: 100%;
            }


        </style>
        <div id="interface">

            <template is="dom-if" if="[[!loading]]">
                <paper-button class="primary" on-tap="characters" raised>CHARACTERS</paper-button>

                <chat-box>
                </chat-box>
            </template>
        </div>

        <canvas id="canvas"></canvas>

    </template>
    <script>
        class GameView extends Polymer.Element {

            static get is() {
                return 'game-view';
            }

            ready() {
                super.ready();

                application.onCompleteUpdate((event) => {
                    this.loading = true;
                    event.status('Initializing..');

                    window.server = event.server;
                    window.character = event.character;
                    window.patch = event.patch;
                    window.onScriptsLoaded = () => {};
                    document.canvas = this.$.canvas;

                    try {
                        let index = 0;

                        // serializes loading of scripts.
                        let loader = (index) => {
                            if (index < event.patch.executable.length) {
                                let script = event.patch.executable[index];
                                event.status('init ' + script.split('.')[0]);

                                let reader = new FileReader();
                                reader.onload = () => {
                                    (1, eval)(reader.result);
                                    index++;
                                    loader(index);
                                }
                                if (event.patch.files[script]) {
                                    reader.readAsText(event.patch.files[script].data);
                                } else {
                                    application.error('Failed to execute bootstrap script: "' + script + '".');
                                }
                            } else {
                                event.status('Starting game..');
                                window.onScriptsLoaded();
                                this.loading = false;

                                // use the patching UI for loading the game scripts.
                                application.showGame();
                            }
                       }
                       loader(index);
                    } catch (err) {
                        console.log(err.message);
                        application.error(err.message);
                        throw err;
                    }
                });
            }

            characters(e) {
                window.onScriptShutdown();
                application.showCharacters();
            }
        }
        window.customElements.define(GameView.is, GameView);
    </script>
</dom-module>