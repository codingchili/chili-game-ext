<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../stats-view.html">

<!--
    @author Robin Duda
    Realm chat.
 -->

<dom-module id="player-status">
    <link rel="import" href="../../style/theme.css" type="css">
    <link rel="import" href="../../style/style.css" type="css">
    <template>
        <style>
            :host {
                position: absolute;
                left: 16px;
                top: 16px;
                width: 416px;
            }

            .frame {
                display: block;
                height: 68px;
                z-index: 495;
            }

            .portrait {
                height: 42px;
                margin-top: 4px;
                margin-left: 10px;
            }

            .name {
                display: block;
                position: absolute;
                left: 66px;
                opacity: 0.7;
                top: 12px;
                font: 16px 'LeagueGothicRegular';
            }

            .health-bar {
                margin-left: 64px;
                margin-right: 8px;
                margin-top: 32px;
                padding: 4px;
                --paper-progress-active-color: #8c0006;
                --paper-progress-container-color: #8c000632;
            }

            .health-bar-mini {
                margin-top: 6px;
            }

            .portrait-mini {
                width: 24px;
                left: 8px;
                top: -10px;
                position: absolute;
            }

            .frame-mini {
                height: 40px;
                width: 276px;
            }

            .energy-bar {
                top: 32px;
                left: 64px;
                margin-left: 64px;
                margin-right: 8px;
                margin-top: 4px;
                padding: 4px;
                --paper-progress-active-color: #4db6ac;
                --paper-progress-container-color: #4db6ac32;
            }

            .level {
                display: block;
                position: absolute;
                top: 4px;
                right: 14px;
                width: 48px;
                text-align: right;
                font-size: larger;
            }

            .exp-bar {
                width: 46px;
                margin-top: -11px;
                padding: 4px;
                margin-left: 6px;
                --paper-progress-active-color: #b6a500;
                --paper-progress-container-color: #b6a50032;
            }

            .health-bar > paper-progress {
                width: 100%;
            }

            .energy-bar > paper-progress {
                width: 100%;
            }

            .exp-bar > paper-progress {
                width: 100%;
            }

            @media (max-width: 728px) {
                :host {
                    top: 0px;
                    left: 0px;
                    right: 0px;
                    width: unset;
                }

                .energy-bar {
                    width: 80%;
                }

                .health-bar {
                    width: 80%;
                }
            }

            #afflictions {
                margin-left: 62px;
                display: flex;
                flex-wrap: wrap;
            }

            .affliction-icon {
                max-width: 24px;
                max-height: 24px;
            }

            @keyframes fadein {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .affliction {
                width: 24px;
                min-width: 24px;
                padding: 4px;
                height: 24px;
                margin: 4px;
                animation: fadein 0.72s ease 1;
            }

            .duration {
                color: #00b0ff;
            }

            .info-table {
                margin-top: 12px;
                width: 100%;
            }

            .title {
                font-size: 2.0em;
            }

            .description {
                margin-top: 12px;
                display: block;
                font-size: larger;
            }

            .class-stats {
                font-size: 14px;
                width: 176px;
            }

            .class-icon {
                position: absolute;
            }

            .stats-tooltip {
                margin-left: 64px;
                z-index: 99999;
            }

            .class-stats {
                z-index: 999999;
            }

        </style>


        <paper-material elevation="3" id="frame" class="interface-box noselect frame">

            <template is="dom-if" if="[[!compact]]">
                <span class="level">[[character.stats.level]]</span>
                <span class="name">[[character.name]]</span>
            </template>

            <div class="class-icon">
                <paper-tooltip animation-delay="0" position="bottom" class="stats-tooltip">
                    <div class="class-stats">
                        Stats
                        <stats-view id="stats" compact="true" selected="{{character}}"
                                    style="display:block"></stats-view>
                    </div>
                </paper-tooltip>
                <img id="portrait" class="portrait" src="[[realm.resources]]/gui/class/[[character.classId]].svg">
            </div>

            <div class="health-bar" id="health-bar">
                <paper-tooltip class="spell-info" animation-delay="0" position="bottom">
                    <span>[[character.stats.health]] / [[character.stats.maxhealth]]</span>
                </paper-tooltip>
                <paper-progress class="transiting" min="0" max="[[character.stats.maxhealth]]"
                                value="[[character.stats.health]]"></paper-progress>
            </div>

            <div class="energy-bar">
                <paper-tooltip class="spell-info" animation-delay="0" position="bottom">
                    <span>[[character.stats.energy]] / [[character.stats.maxenergy]]</span>
                </paper-tooltip>
                <paper-progress class="transiting" min="0" max="[[character.stats.maxenergy]]"
                                value="[[character.stats.energy]]"></paper-progress>
            </div>

            <div class="exp-bar">
                <paper-tooltip class="spell-info" animation-delay="0" position="bottom">
                    <span>[[character.stats.experience]] / [[character.stats.nextlevel]]</span>
                </paper-tooltip>
                <paper-progress class="transiting" min="0" max="[[character.stats.nextlevel]]"
                                value="[[character.stats.experience]]"></paper-progress>
            </div>
        </paper-material>

        <div id="afflictions">
            <template is="dom-repeat" items="{{afflictions}}" as="affliction">
                <div class="affliction interface-box">
                    <img src="[[realm.resources]]/gui/afflictions/[[affliction.id]].svg" class="affliction-icon"
                         alt="affliction">

                    <paper-tooltip class="spell-info" animation-delay="0" position="bottom">
                        <span class="title">[[affliction.name]]</span>

                        <table class="info-table">
                            <tr>
                                <th>Duration</th>
                            </tr>
                            <tr style="text-align: center;">
                                <td class="duration">[[affliction.duration]]s</td>
                            </tr>
                        </table>

                        <span class="description">{{_description(affliction)}}</span>
                    </paper-tooltip>
                </div>
            </template>
        </div>

    </template>
    <script>
        class PlayerStatus extends Polymer.MutableData(Polymer.Element) {

            static get is() {
                return 'player-status';
            }

            static get properties() {
                return {
                    compact: {
                        type: Boolean,
                        value: false
                    }
                }
            }

            constructor() {
                super();
                this.afflictions = [];
                this.compact = false;
            }

            ready() {
                super.ready();

                setInterval(() => {
                    for (let i = 0; i < this.afflictions.length; i++) {
                        this.set(`afflictions.${i}.duration`, this.afflictions[i].duration - 1);
                    }
                }, 1000);

                application.onCharacterUpdate(character => {
                    this._updatePlayerState(character);
                });

                application.onCharacterLoaded(character => {
                    this._updatePlayerState(character);
                });

                application.onRealmLoaded(realm => {
                    this.realm = realm;
                });

                if (this.compact) {
                    this.$['health-bar'].classList.add('health-bar-mini');
                    this.$.frame.classList.add('frame-mini');
                    this.$.portrait.classList.add('portrait-mini')
                }
            }

            _updatePlayerState(character) {
                this.character = character;
                this.afflictions = [];
                this.afflictions = character.afflictions.list;
                this.notifyPath("afflictions");
                this.shadowRoot.querySelector('#stats').update(character);
            }


            _description(affliction) {
                return eval('`' + affliction.description + '`');
            }
        }

        window.customElements.define(PlayerStatus.is, PlayerStatus);
    </script>
</dom-module>