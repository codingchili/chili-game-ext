<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<link rel="import" href="../character-stats.html">

<!--
    @author Robin Duda
    Realm chat.
 -->

<dom-module id="loot-dialog">
    <link rel="import" href="../../style/theme.css" type="css">
    <link rel="import" href="../../style/style.css" type="css">
    <template>
        <style>
            :host {
            }

            #dialog {
                pointer-events: auto;
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                min-width: 428px;
                max-width: 428px;
                min-height: 112px;
                z-index: 999;
            }

            .interface-box {
                background-color: #000000;
                opacity: 1;
            }

            span {
                padding: 0.28rem;
            }

            .dialog-entity {
                margin-top: 8px;
                padding-left: 16px;
                display: block;
                color: var(--paper-grey-300);
            }

            #dialog-close:hover {
                color: var(--player-class-theme);
            }

            #dialog-close {
                position: absolute;
                right: 8px;
                top: 8px;
            }

            @keyframes fadein {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 0.64;
                }
            }

            #container {
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                position: absolute;
                display: none;
                pointer-events: all;
                z-index: 500;
            }

            #overlay {
                width: 100%;
                height: 100%;
                z-index: 400;
                background-color: black;
                opacity: 0.64;
                animation: fadein 1.2s ease 1;
                pointer-events: none;
            }

            #loot-items {
                display: flex;
                flex-wrap: wrap;
            }

            .item-info {

            }

            .item-stats {
                margin-top: 16px;
                font-size: small;
            }

            .item-name {
                font-size: large;
            }

            .item-description {
                margin-top: 16px;
                font-size: small;
            }

            .stats-header {
                display: block;
            }

        </style>

        <div id="container">
            <div id="overlay"></div>

            <paper-material elevation="3" class="interface-box" id="dialog">
                <iron-icon icon="icons:close" id="dialog-close" on-down="_stop"></iron-icon>

                <span class="dialog-entity">[[target.name]]</span>

                <div id="loot-items">
                    <template is="dom-repeat" items="[[loot]]" as="item">
                        <div on-click="_loot">
                            <paper-tooltip animation-delay="0" position="bottom" class="stats-tooltip">
                                <div class="item-info">
                                    <div class="item-name">[[item.name]]</div>
                                    <span class="stats-header"
                                          style$="color:[[_rarity(item.rarity)]]">[[item.rarity]]</span>
                                    <character-stats class="item-stats" compact="true" selected="{{item}}"
                                                     style="display:block"></character-stats>
                                    <div class="item-description">[[item.description]]</div>
                                </div>
                            </paper-tooltip>
                            <img src="[[realm.resources]]/gui/item/icon/[[item.icon]]"/>
                        </div>
                    </template>
                </div>
            </paper-material>
        </div>
    </template>
    <script>
        class LootDialog extends Polymer.GestureEventListeners(Polymer.Element) {

            static get is() {
                return 'loot-dialog';
            }

            ready() {
                super.ready();

                server.connection.setHandler('loot_list', {
                    accepted: (e) => {
                        this.set('target', game.entities[e.targetId]);
                        this.set('loot', e.lootList);

                        if (e.lootList.length > 0) {
                            this._start();
                        } else {
                            this._stop();
                        }
                    },
                    error: (event) => {
                        game.texts.chat(game.player, {text: event.message});
                    }
                });

                application.onRealmLoaded((realm) => {
                    this.realm = realm;
                })
            }

            _rarity(level) {
                switch (level) {
                    case 'COMMON':
                        return '#9f9ea4';
                    case 'UNCOMMON':
                        return '#13ff00';
                    case 'RARE':
                        return '#00a9a2';
                    case 'EPIC':
                        return '#ff00b4';
                    case 'LEGENDARY':
                        return '#b2a600';
                }
            }

            _loot(e) {
                game.inventory.takeLoot(this.target, e.model.item);
            }

            _start() {
                this.$.container.style.display = 'block';
                input.block();
            }

            _stop() {
                this.$.container.style.display = 'none';
                game.inventory.unsubscribeLootList(this.target);
                input.unblock();
            }
        }

        window.customElements.define(LootDialog.is, LootDialog);
    </script>
</dom-module>